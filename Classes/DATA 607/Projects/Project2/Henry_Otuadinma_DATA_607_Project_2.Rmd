---
title: "DATA 607 Project 2"
author: "Henry Otuadinma"
date: "24 February 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(xml2)
library(rvest)
library(stringr)
library(DT)

```

#### Problem statement
I want to purchase the cheapest 5 top best seller and highly rated books on Amazon for my library.

#### Overview
I will produced a .csv file containing 250 observations and 8 variables describing up to date record of 50 top selling books across 5 top genres each scrapped from Amazon. 
The data will contain descriptive observations in the wide format as each book will be contained in a single row and eight variables depicting its title, author, genre, rating, price, type (kindle edition, paperback, etc), etc. 

The data will then be worked on using appropriate functions like `group_by`, `filter`, `arrange`, `select`, etc from the `dplyr` package to see how the books compare with each others in terms of their genres, types, prices, and the most rated such that at the end, I will be able to to know the 5 cheapest top selling books (one each from the 5 genres) that I can purchase on Amazon.

#### Data Scrapping
This involves 

```{r}

religionRaw <- html_nodes(read_html('https://www.amazon.com/Best-Sellers-Books-Religion-Spirituality/zgbs/books/22/ref=zg_bs_nav_b_1_b', encoding = "en_US.UTF-8"), 'ol#zg-ordered-list')

sciMathRaw <- html_nodes(read_html('https://www.amazon.com/Best-Sellers-Books-Science-Math/zgbs/books/75/ref=zg_bs_nav_b_1_b', encoding = "en_US.UTF-8"), 'ol#zg-ordered-list')

litFictionRaw <- html_nodes(read_html('https://www.amazon.com/Best-Sellers-Books-Literature-Fiction/zgbs/books/17/ref=zg_bs_nav_b_1_b', encoding = "en_US.UTF-8"), 'ol#zg-ordered-list')

historyRaw <- html_nodes(read_html('https://www.amazon.com/Best-Sellers-Books-History/zgbs/books/9/ref=zg_bs_nav_b_1_b', encoding = "en_US.UTF-8"), 'ol#zg-ordered-list')

lawRaw <- html_nodes(read_html('https://www.amazon.com/Best-Sellers-Books-Law/zgbs/books/10777/ref=zg_bs_nav_b_1_b', encoding = "en_US.UTF-8"), 'ol#zg-ordered-list')

```

Some of the book titles contain `:` which implies a long decriptive part of the tile comes after the colon. These aere therefore
shortened at the `:`

```{r}

processNodes <- function(rawNode, genre)
{
    imgs <- vector()
    genres <- vector()
    titles <- vector()
    authors <- vector()
    ratings <- vector()
    numRaters <- vector()
    types <- vector()
    prices <- vector()
    
    itemsRaw <-html_nodes(rawNode, 'span.zg-item')
  
    for(i in 1: length(itemsRaw))
    {
        x <- itemsRaw[i]
        xImg <- str_replace_all(str_extract(x, '(?<=src=)"(.+?)"'), '\"', '')
        xTitle <- str_trim(str_replace_all(html_text(html_node(x, '.a-link-normal > div')), "[\r\n]" , ""), side='both') 
        
        if(str_detect(xTitle, ':') == TRUE)
        {
          xTitle <- str_split(xTitle, ':')[[1]][1] # Shorten the title by splitting at the colon (:)
        }
        
        xAuthor <- str_trim(html_text(html_node(x, '.a-link-child')), side='both')
        
        if(is.na(xAuthor) || is.null(xAuthor))
        {
          xAuthor <- str_trim(html_text(html_node(x, 'span.a-color-base')), side='both')
        }
        
        xRating <- str_trim(str_extract(html_node(x, '.a-icon-alt'), '\\d+(\\.\\d+)'), side='both')
        
        xNumRaters <- str_replace(str_trim(html_text(html_node(x, 'div.a-icon-row > a.a-size-small')), side='both'), ',', '')
        
        if(is.na(xNumRaters) || is.null(xNumRaters))
        {
          xNumRaters <- str_replace(str_trim(html_text(html_node(x, 
                        'div.a-spacing-none > a-link-normal')), side='both'), ',', '')
        }
       
        xType <- str_trim(html_text(html_node(x, 'div.a-size-small > span.a-color-secondary')), side='both')
        
        p <- str_extract(html_node(x, 'span.p13n-sc-price'), '\\d+(\\.\\d+)')
        
        xPrice <-  round(as.numeric(p), 2)
        
        if(is.na(xPrice) || is.null(xPrice))
        {
          xPrice <- str_extract(str_trim(html_text(html_node(x, 
                        'span.a-color-price')), side='both'), '[[:alpha:] ]{2,}')
        }
        
        imgs <- c(imgs, xImg)
        genres <- c(genres, genre)
        titles <- c(titles, xTitle)
        authors <- c(authors, xAuthor)
        ratings <- c(ratings, xRating)
        numRaters <- c(numRaters, xNumRaters)
        types <- c(types, xType)
        prices <- c(prices, xPrice)
    }
    
    return(data.frame(title = titles, author = authors, genre = genres, rating = ratings, img = imgs,
                      numRater = numRaters, type = types, price = prices))
}

```


Returns 5 different dataframes of 50 observations and 8 variables
 

```{r, warning=FALSE, message=FALSE}

religion <- processNodes(religionRaw, 'Religion')
science <- processNodes(sciMathRaw, 'Science & Math')
fiction <- processNodes(litFictionRaw, 'Literature & Fiction')
history <- processNodes(historyRaw, 'History')
law <- processNodes(lawRaw, 'Law')

```

Combine all datframes into one and check the dimensions of the resultant dataframe
```{r}
books <- rbind(history, religion, science, fiction, law)
dim(books)
```

Preview the data
```{r}

s <- subset(books, select=c(title, author, genre, rating, numRater, type, price)) #Remove the book image url

datatable(head(s, 10), colnames= c("Title", "Author", "Genre", "Rating", "Number of reviewers", "Type", "Price($)"), class = 'cell-border stripe', options = list(
  initComplete = JS(
    "function(settings, json) {",
    "$(this.api().table().header()).css({'background-color': 'steelblue', 'color': '#fff', 'text-align': 'center !important'});",
    "$(this.api().table().body()).css({'color': '#000', 'text-align': 'center !important'});",
    "}")
))

```

```{r}
write.csv(books, "topBooks.csv", row.names=FALSE)
```


```{r}

airlines <- c('ALASKA', 'ALASKA', 'ALASKA', 'ALASKA', 'ALASKA',
              'AM WEST', 'AM WEST', 'AM WEST', 'AM WEST', 'AM WEST')
destinationCity <- c('Los Angeles','Los Angeles', 'Los Angeles', 'Los Angeles', 'Phoenix', 'Phoenix', 'Phoenix', 'Phoenix', 
                     'San Diego', 'San Diego', 'San Diego', 'San Diego', 'San Francisco', 'San Francisco', 'San Francisco', 'San Francisco',
                     'Seattle', 'Seattle', 'Seattle', 'Seattle')

alaskaOnTime <- c(497, 221, 212, 503, 1841)
alaskaDelayed <- c(62, 12, 20, 102, 305)

amWestOnTime <- c(694, 4840, 383, 320, 1841)
amWestDelayed <- c(117, 415, 65, 129, 61)

```

```
